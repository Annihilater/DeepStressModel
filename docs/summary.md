# DeepStressModel 数据加密问题解决方案概述

## 问题背景

DeepStressModel 的离线包加密系统存在数据集解密失败的问题。通过分析，我们发现主要原因是会话密钥长度非标准（54字节）不适合直接用作AES密钥，且缺乏明确的密钥派生方法和加密元数据。

## 调查过程

1. **分析现有代码**：通过查看 `crypto.py` 和相关代码，确认了目前的加密流程：
   - 使用 API 密钥通过 PBKDF2-SHA256 派生密钥来加密 RSA 私钥
   - 使用 RSA 私钥解密会话密钥
   - 使用会话密钥解密数据集

2. **问题识别**：
   - 私钥解密和会话密钥解密部分工作正常
   - 数据集解密失败，主要是因为 54 字节的会话密钥不能直接用作 AES 密钥
   - 缺少明确的密钥派生方法
   - 没有提供足够的加密元数据（如 IV、盐值等）

3. **尝试解决方案**：
   - 修改 `debug_decrypt.py` 尝试多种解密方法
   - 测试不同的密钥处理方法（截断、散列等）
   - 尝试多种 AES 模式和填充方式
   - 所有尝试均未成功解密数据集

## 解决方案

基于调查结果，我们设计了一套完整的加密解决方案：

1. **修订加密规范**（`docs/revised_crypto_specification.md`）：
   - 保留已验证的私钥加密和会话密钥加密方法
   - 设计新的数据集加密方式，引入 HKDF 密钥派生函数
   - 明确加密算法（AES-256-CBC-PKCS7）
   - 更新离线包格式（版本 4.0）

2. **提供参考实现**：
   - 解密示例代码（`docs/revised_decrypt_example.py`）
   - 加密示例代码（`docs/revised_encrypt_example.py`）

3. **服务端实现指南**（`docs/server_implementation_guide.md`）：
   - 详细的服务端代码修改步骤
   - HKDF 密钥派生的实现
   - 数据集加密方法的修改
   - 兼容性考虑
   - 错误处理和日志记录建议

4. **服务端开发提示词**（`docs/server_implementation_prompt.md`）：
   - 为服务端开发人员提供明确的修改指导
   - 提供具体的 JSON 结构和代码参考

## 技术要点

1. **HKDF 密钥派生**：
   - 使用 HKDF-SHA256 从任意长度的会话密钥派生标准 32 字节 AES 密钥
   - 符合 RFC 5869 规范
   - 使用随机盐值增加安全性

2. **标准化加密方法**：
   - 使用 AES-256-CBC 加密算法
   - PKCS7 填充方式
   - 随机生成 IV
   - 明确的加密参数

3. **元数据增强**：
   - 在加密数据结构中包含算法信息
   - 记录密钥派生方法和参数
   - 包含必要的 IV 和盐值

## 实施建议

1. **逐步实施**：
   - 先在测试环境实施新的加密方法
   - 保留对旧版格式的解密支持
   - 逐步迁移到新格式

2. **验证测试**：
   - 添加全面的单元测试和集成测试
   - 验证各种边缘情况
   - 确保向后兼容性

3. **监控与反馈**：
   - 实施后密切监控解密失败率
   - 收集客户端反馈
   - 必要时进行调整

## 安全考虑

1. 保持密钥管理的安全性
2. 使用加密安全的随机数生成器
3. 定期审查和更新加密实现
4. 对敏感数据实施适当的访问控制

## 结论

通过引入标准化的密钥派生方法和明确的加密参数，新的加密实现将解决当前数据集解密失败的问题，同时保持高水平的安全性和兼容性。建议服务端开发团队按照提供的指南进行实施，并进行充分的测试以确保系统稳定性。 